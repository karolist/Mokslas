══════════════════════════════════════
    ПОСТРАНИЧНАЯ ОРГАНИЗАЦИЯ ПАМЯТИ
──────────────────────────────────────
   Cущность постраничной организации
               памяти
──────────────────────────────────────
  Подкачка-это еще один тип управления
памятью,которая используется для  вир-
туальной памяти многозадачных ОС.
 В отличии от сегментации,которая  мо-
дернизирует программы и данные в  раз-
личные места сегмента.Подкачка  приво-
дит программы к многочисленным страни-
цам одного и того же  размера.Подкачка
не имеет прямого отношения к  логичес-
кой  структуре  программы  в  то время
как селекторы сегмента могут быть рас-
смотрены как  логические имена  модуля
программы или структуры данных.
 Страница  обычно  соответствует части
модуля или структуры  данных.Используя
преимущества локальности  ссылки,толь-
ко  не  большое  количество страниц из
каждой активной задачи необходимо дер-
жать в памяти в один определенный  мо-
мент времени.
──────────────────────────────────────
         Организация подкачки
          Механизм подкачки
──────────────────────────────────────
 80386 использует 2 уровня таблиц  для
перевода  линейного  адреса  (из блока
сегментации в физический адрес).
 Имеется  3  компонента  для  подкачки
  80386:
   1.Указатель страницы.
   2.Таблица страницы.
   3.Сами страницы (рамки страницы).
 Все элементы резидентной памяти меха-
низма подкачки 80386 равны 4 Кбайтам.
 Одинаковый размер для всех  элементов
упрощает локацию  памяти и  реалакацию
схем,поскольку не существует ни  каких
проблем с фрагментацией памяти.
 На рисунке показано как работает  ме-
ханизм  подкачки.(Для  вызова  нажмите
F10).
──────────────────────────────────────
-Базовый регистр дескриптора подкачки-
──────────────────────────────────────
 КR2 является регистром линейного  ад-
реса ошибки подкачки.Он содержит  32-х
битовый линейный адрес,который вызыва-
ет  определение  ошибки  в   последней
странице.
 KR3-это регистр физического  базового
адреса указателя страницы.Он  содержит
физический  начальный  адрес указателя
страницы.Младшие  12  бит  KR3  всегда
равны 0 для того чтобы обеспечить  та-
кое  состояние  при  котором указатель
страницы всегда выравнен.
 Загружается  он  посредством  команды
MOV KR3,REG.
 Команда  вызывает  КШ-ввода   таблицы
страниц.
──────────────────────────────────────
           Указатель страницы
──────────────────────────────────────
 Указатель страницы в длину 4  Кбайта,
позволяет размещать 1024 единиц указа-
теля страниц.Каждая единица  указателя
страницы  содержит  адрес   следующего
уровня  таблицы  страницы,информацию о
таблице  страницы.Содержание   единицы
указателя страницы показано на  рисун-
ке.Старшие  10  бит  линейного  адреса
(А22-А31) используются как индекс  для
выбора  правильной  единицы  указателя
страницы.

──────────────────────────────────────
          Таблицы страниц
──────────────────────────────────────
 Каждая  таблица  страницы  4 Кбайта и
содержит до 1 Кбайта элементов таблицы
страницы.Элементы таблицы страницы со-
держат начальный адрес рамки  страницы
и статистическую информацию о  страни-
це.Биты  адреса  A12-A21  используются
как индекс для  выбора одного из  эле-
ментов таблицы страницы.
 Таблицы страниц могут быть размещены
между задачами и записаны на диск.
──────────────────────────────────────
 ЭЛЕМЕНТЫ ТАБЛИЦЫ И УКАЗАТЕЛЬ СТРАНИЦ
──────────────────────────────────────
 Младшие 12бит элементов таблицы стра-
ницы  и  элементов  указателя страницы
содержат  статическую   информацию   о
страницах и таблицах страницы соответ-
ственно.Бит Р  указывет какой  элемент
может быть использован в передаче  ад-
реса.Если  Р=1,то  элемент  может быть
использован  для  адресной трансляции.
Если Р=0,то элемент не может быть  ис-
пользован для трансляции и все осталь-
ные биты имеются в наличии для исполь-
зования программой.НАПРИМЕР: остающие-
ся 37 бит могут быть использованы  для
указания,где на диске помещена страни-
ца.А(бит 5,прав доступа)  устанавлива-
ется  80386  для  двух типов элементов
перед тем как происходит доступ к про-
чтению или написанию  преобразованного
элемента.
 D(бит6)  устанавливается  в  1  перед
описанием  адреса  покрытого элемента,
он(бит  D)  неопределен  для элементов
указателей  страницы.Когда  биты A,D,P
изменены микропроцессор 80386  выраба-
тывает цикл прочтения,написания и  из-
менения,который  захватывает  адресную
шину  и  предотвращает  "конфликты"  с
другими процессорами или  дополнитель-
ными    устройствами.Программы,которые
изменяют данные биты должны  использо-
вать команду LOCK для обеспечения  це-
лостности таблицы страницы для  много-
пользовательских систем.
 Анализируя,как долго страница была  в
памяти  со  времени  доступа.ОС  может
выполнить алгоритм замены страницы,как
страницы которая последнее время прак-
тически не использовалась.
 Бит  US2(пользователь,супервизор)   и
READ/WRITE  ,RV  бит  используется для
обеспечения  признаков  защиты следую-
щих страниц.

──────────────────────────────────────
     Защита уровня страницы
──────────────────────────────────────
 80386  обеспечивает  наборы  защитных
признаков для систем подкачки.Механизм
подкачки имеет 2 уровня защиты.
 Пользователь,который    соответствует
уровню 3,защиты  основана на  сегмета-
ции и  супервизор включает  все уровни
защиты 0,1 и 2.
 Программа,выполняемая на уровне 0,1 и
2 обходит защиты страницы,хотя  защита
основанная  на  сегментации попрежнему
вводится в действие аппаратурой.
──────────────────────────────────────
     Буфер предистории трансляции
──────────────────────────────────────
 Аппаратура подкачки 80386  предназна-
чена для поддержания требований систе-
мы  виртуальной  памяти  и  страничной
организации.Однако,работа  может   су-
щественно  ухудшиться,если  процессору
потребовалось  получить  доступ  к 2-м
уровням таблицы  для каждой  из ссылки
памяти.
 Для  решения  данной  проблемы  80386
хранит  КШ  наиболее  часто  доступных
страниц  к  которым  имеется   доступ.
Этот КШ называется  TLB - буфер  пред-
истории трансляции.TLB  - это  4-x до-
рожечный набор  соотносящийся с  32-мя
элементами КШ таблицы страницы.Он  ав-
томатически хранит наиболее часто  ис-
пользуемые элементы таблицы страницы в
процессоре.32 элемента TLB  соотнесен-
ные с 4 Кбайтным размером страницы.Это
приводит к покрытию 128К адресов памя-
ти.Для многих общих многозадачных сис-
тем  TLB  будет  иметь коэффициент эф-
фективности около 98%.Это означает,что
процессору  будет  необходимо получить
доступ к двухуровневой структуре стра-
ницы на  2 всех  ссылок памяти.На  ри-
сунке представлена  как TLB  дополняет
механизм подкачки 80386.
──────────────────────────────────────
          Операция подкачки
──────────────────────────────────────
 Аппаратура подкачки работает в следу-
ющих режимах:
 Аппаратура  подкачки  после получения
32-х битового линейного адреса из бло-
ка  сегментации,сравнивает  старшие 20
битов линейного адреса со всеми  32-мя
элементами TLB для  определения,подхо-
дят ли они друг другу.Если они соотве-
тствуют друг другу,то значит 32-х  би-
товый физический  адрес вычисляется  и
затем  помещается  на  адресную  шину.
Однако если  элемент таблицы  страницы
не  находится  в  TLB,то 80386 прочтет
соответствующий   элемент    указатель
страницы.Если Р=1 в Элементе Указателя
Страницы(а не в Элементе Таблицы Стра-
ницы),значит  таблица  страницы(а   не
страница) находится  в памяти  и 80386
прочитает   соответствующий    элемент
таблицы  и   установит  бит   доступа.
Если Р=1 в Элементе Таблицы  Страницы-
то страница находится в памяти и 80386
обновит биты доступа.Если Р=0,то неза-
висимо  от  того,где  он  равен нулю в
Элементе Таблицы Страницы или Элементе
Указателя Страницы,микропроцессор  бу-
дет  генерировать  ошибку страницы(Ис-
ключение 14).80386 также  вырабатывает
ошибку     страницы(Исключение14),если
ссылка  на  память  нарушает  признаки
защиты  страницы(т.е.   U/S  or   R/W)
(пытается  писать  на страницу,которую
можно только читать).CR2 будет  содер-
жать  линейный  адрес,который   вызвал
ошибку страницы.Поскольку Исключение14
классифицируется  как  ошибка CS:IP,то
он укажет  на команду,которая  вызвала
ошибку  страницы.16-ти  битовый  адрес
ошибки проталкивается как часть  стра-
ницы,будет содержать биты  статуса,ко-
торые  указывают  на  причину   ошибки
страницы.На  рисунке  показан   формат
ошибки  страницы,показан  код   ошибки
страницы и интерпритация битов.

──────────────────────────────────────
        Ответственность ОС
 80386 заботится  о процессе  перевода
адреса страницы не требуя дополнитель-
ного времени от ОС.ОС ответственна  за
установку таблицы первоначальной стра-
ницы и обработку любых ошибок  страни-
цы.ОС также должна обнулить  TLB,когда
происходит  любые  измененния  с  эле-
ментом  в  таблице  страницы.ОС должна
перезагрузить CR3,для того,чтобы  выз-
вать  обнуление  TLB.Установка таблиц-
это загрузка  CR3 с  адресом Указателя
Страницы и выделение памяти для Указа-
теля  Страницы  и  Таблицы   Страницы.
Первичная ответственность операционной
системы является выполнение "политики"
перекачки  и  обработка  всех   ошибок
страницы.Последней заботой ОС  являет-
ся обеспечение такого условия,при  ко-
тором кэш TLB соответствует информации
в таблице страницы,в частности,в любое
время,когда   ОС   устанавливает   бит
Р(присутствия)  в   элементе   Таблицы
Страницы,на  0,то   TLB  должно   быть
обнулено.ОС могут воспользоваться тем,
что CR3 помещается в память как  часть
TSS,чтобы дать каждой задаче или груп-
пе задач свой собственный набор Табли-
цы Страницы.
──────────────────────────────────────
     Виртуальная конфигурация 8086
──────────────────────────────────────
      Выполнение программ 8086
 80386  позволяет  выполнение программ
8086 как в реальном,так и в  виртуаль-
ном  режиме.Виртуальный  режим   80386
предлагает   пользователю   наибольшую
гибкость.Он  позволяет  ему воспользо-
ваться  всеми  преимуществами   80386,
кроме того,что  также можно  выполнять
в нем  же программы  как и  в реальном
режиме.Защитный механизм  80386,позво-
ляет одновременное выполнение операци-
онных систем  и программ 8086,а опера-
ционная система микропроцессора 80386,
также программ 80286,80386.Таким обра-
зом,работая  на  многопользовательском
компьюторе  с  микропроцессором 80386,
один человек может использовать  бланк
разброса MS DOS,другой может использо-
вать MS  DOS,а третий  может использо-
вать  многочисленные  прикладные прог-
раммы  и   возможности  UNIX.   Каждый
из  них  будет  думать,что  только  он
один  является  полным   пользователем
компьютера.Данная  концепция  показана
на  рисунке,для  его  вызова   нажмите
клаввишу <F10>.
══════════════════════════════════════
--------Механизм адресации в---------
--------виртуальном 8086 режиме------
 Одним из основных различий адресации
виртуального режима от остальных (ре-
ального и защищенного) является то,как
интерпретируются селекторы.
 Когда микропроцессор работает в  вир-
туальном 8086 режиме,т.е.регистры сег-
мента  используются  точно  в такой же
манере,как и в реальном  режиме.Содер-
жание сегментных  регистров,сдвигается
влево на 4 бита и прибавляется  смеще-
ние для формирования физического адре-
са.80386 позволяет ОС определить какие
программы используют механизм  адреса-
ции 8086,а какие программы  используют
адресацию защищенного режиме,на  осно-
вании задачи.Через использование  под-
качки,адресное  пространство  задачи в
1Мбайт,в виртуальном режиме может быть
отображено  в  любом  месте  4Гбайтном
пространстве  линейного  адреса 80386.
Как и в реальном режиме адреса в  вир-
туальном  режиме,которые   превосходят
1Мбайт будут вырабатывать Исключение13
однако  эти  ограничения  не  являются
важными  поскольку  большинство задач,
которые выполняются в виртуальном 8086
режиме являются одиночными программами
микропроцессора  8086(а  их  размер не
превосходит 1Мбайт).
──────────────────────────────────────
    Подкачка в Виртуальном режиме
──────────────────────────────────────
 Механизм подкачки позволяет  одновре-
менную  обработку  многочисленных про-
грамм и обеспечивает защиту и изоляцию
операционных систем.Хотя иметь аппара-
туру подкачки для того,чтобы обрабаты-
вать  задачи  в  виртуальном режиме,он
необходим чтобы обрабатывать многочис-
ленные задачи в этом режиме или  пере-
мещать  их  в  адресном   пространстве
большем,чем 1Мбайт.
 Аппаратура  подкачки  позволяет 20-ти
битовый  линейный  адрес  выработанный
программой   в   виртуальном   режиме,
разбить на 256 страниц.Одна из страниц
может быть  помещена в  любом месте  в
пределах 4-х гигабайтного пространства
физического  адреса  80386.Кроме того,
поскольку CR3(базовый регистр указате-
ля страницы)загружается при переключе-
нии задачи.Каждая задача в виртуальном
режиме  может  использовать  различные
схемы отображения,для того чтобы отоб-
разить страницы  на различные  места в
памяти.И  наконец,аппаратура  подкачки
позволяет разделение кода ОС 8086 меж-
ду многочисленными аппликациями  8086.
На  рисунке  показано  как  аппаратура
подкачки 80386 обеспечивает  многочис-
ленные программы 8086 в системе требо-
ваний страницы в виртуальной памяти.


.
